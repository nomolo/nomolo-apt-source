name: Build, Lint and Publish APT Repo

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  CONTACT_EMAIL: "huangnomolo@gmail.com"

jobs:
  # === JOB 1: 构建、检查 ===
  build-and-lint:
    runs-on: ubuntu-latest
    # 将版本号导出，供下一个发布 Job 使用
    outputs:
      NERDCTL_VERSION: ${{ steps.check.outputs.NERDCTL_VERSION }}
      CNI_VERSION: ${{ steps.check.outputs.CNI_VERSION }}
      BUILDKIT_VERSION: ${{ steps.check.outputs.BUILDKIT_VERSION }}
    
    steps:
      - name: Setup Environment Variables
        run: echo "FINAL_DEB_DIR=${{ runner.temp }}/final_deb" >> $GITHUB_ENV
          
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev jq curl wget lintian

      - name: Check for updates
        id: check
        env:
          TOKEN: ${{ secrets.TOKEN }}
        run: |
           bash scripts/check_update.sh

      - name: Run Build Script
        env:
          NERDCTL_VERSION: ${{ steps.check.outputs.NERDCTL_VERSION }}
          CNI_VERSION: ${{ steps.check.outputs.CNI_VERSION }}
          BUILDKIT_VERSION: ${{ steps.check.outputs.BUILDKIT_VERSION }}
          NERDCTL_TAG: ${{ steps.check.outputs.NERDCTL_TAG }}
          CNI_TAG: ${{ steps.check.outputs.CNI_TAG }}
          BUILDKIT_TAG: ${{ steps.check.outputs.BUILDKIT_TAG }}
        run: |
          mkdir -p "$FINAL_DEB_DIR"
          for script in scripts/build_sh/*.sh; do
            echo "Running build script: $script"
            bash "$script"
          done

      - name: Run Lintian Check
        run: |
          echo "###Lintian Check Results" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # 把结果同时输出到 屏幕(tee) 和 Summary
          lintian --info --no-tag-display-limit "$FINAL_DEB_DIR"/*.deb | tee -a $GITHUB_STEP_SUMMARY || true
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages
          path: ${{ env.FINAL_DEB_DIR }}/*.deb
          retention-days: 1

  # === JOB 2: 发布到 APT 仓库（需要审批） ===
  publish:
    needs: build-and-lint  # 必须等上一步成功
    runs-on: ubuntu-latest
    environment: production # 触发在 Settings 里设置的审批保护
    permissions:
      contents: write
    
    steps:
      - name: Setup Environment Variables
        run: echo "DOWNLOAD_DEB_DIR=${{ runner.temp }}/downloaded_debs" >> $GITHUB_ENV

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: deb-packages
          path: ${{ env.DOWNLOAD_DEB_DIR }} # 下载到临时目录

      - name: Install Reprepro & GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y reprepro gnupg

      - name: Import GPG Key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          printf "%s" "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Update APT Repo
        env:
          # 从上一个 Job 获取版本号
          NERDCTL_VERSION: ${{ needs.build-and-lint.outputs.NERDCTL_VERSION }}
          CNI_VERSION: ${{ needs.build-and-lint.outputs.CNI_VERSION }}
          BUILDKIT_VERSION: ${{ needs.build-and-lint.outputs.BUILDKIT_VERSION }}
        run: |
          # 切换到 gh-pages 分支 (孤儿分支)
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # 拉取 gh-pages 分支的内容到 repo 目录
          if git fetch origin gh-pages 2>/dev/null; then
            echo "gh-pages branch exists. Checking out..."
            git switch gh-pages
          else
            echo "gh-pages branch does not exist. Creating orphan branch..."
            git switch --orphan gh-pages
            git rm -rf . || true
          fi

          # 初始化配置
          mkdir -p conf
          if [ ! -f conf/distributions ]; then
            cat <<EOF > conf/distributions
          Origin: Nomolo
          Label: AptRepo
          Codename: stable
          Architectures: amd64
          Components: main
          Description: Nomolo's Personal Apt Repository
          SignWith: default
          EOF
          fi

          # 添加包
          count=0
          for package in "$DOWNLOAD_DEB_DIR"/*.deb; do
            if [ -f "$package" ]; then
              echo "Processing $package..."
              reprepro -b . includedeb stable "$package" || echo "Skipping duplicate."
              count=$((count+1))
            fi
          done

          if [ "$count" -eq 0 ]; then
             echo "No deb files found to add."
             exit 0
          fi

          # 提交更改
          COMMIT_MSG="Update repo with version:
          - nerdctl: $NERDCTL_VERSION
          - CNI: $CNI_VERSION
          - buildkit: $BUILDKIT_VERSION"

          git add dists pool db conf
          
          if ! git diff --cached --quiet; then
            git commit -m "$COMMIT_MSG"
            git push origin gh-pages
          else
            echo "No changes to commit."
          fi